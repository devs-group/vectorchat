name: Build and Publish Containers

on:
  push:
    branches:
      - main
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  security-events: write
  checks: write

concurrency:
  group: vectorchat-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    outputs:
      secrets-valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Validate required secrets
        id: check
        run: |
          if [[ "${{ secrets.GITHUB_TOKEN }}" != "" ]]; then
            echo "valid=true" >> "$GITHUB_OUTPUT"
          else
            echo "valid=false" >> "$GITHUB_OUTPUT"
            echo "GITHUB_TOKEN is required"
            exit 1
          fi

  build-staging:
    if: github.ref == 'refs/heads/main' && needs.validate-secrets.outputs.secrets-valid == 'true'
    needs: validate-secrets
    uses: ./.github/workflows/build-containers.yml
    with:
      environment: staging
      tag: staging
      push_image: true
    secrets: inherit

  build-production:
    if: startsWith(github.ref, 'refs/tags/') && needs.validate-secrets.outputs.secrets-valid == 'true'
    needs: validate-secrets
    uses: ./.github/workflows/build-containers.yml
    with:
      environment: production
      tag: latest
      extra_tags: |
        type=ref,event=tag
      push_image: true
    secrets: inherit

  security-summary:
    if: always() && (needs.build-staging.result == 'success' || needs.build-production.result == 'success')
    needs: [validate-secrets, build-staging, build-production]
    runs-on: ubuntu-latest
    steps:
      - name: Security scan summary
        run: |
          echo "Container security scanning completed"
          echo "Check the Security tab in GitHub for detailed vulnerability reports"
