# /etc/config/oathkeeper/rules.yaml  (matching_strategy: regexp)

# 1) Public: /health
- id: allow-health
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/health
    methods: [GET, HEAD, OPTIONS]
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# 2) Public: /billing/plans
- id: allow-billing-plans
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/billing/plans
    methods: [GET, HEAD, OPTIONS]
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# 3) Public: /stripe/webhook
- id: allow-stripe-webhook
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/stripe/webhook
    methods: [POST, HEAD, OPTIONS]
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# 4) Everything else: must be authenticated via Kratos session cookie
- id: require-auth
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/<.*>
    methods: [GET, POST, PUT, PATCH, DELETE, HEAD, OPTIONS]
  authenticators:
    - handler: cookie_session
  authorizer:
    handler: allow
  mutators:
    - handler: header
