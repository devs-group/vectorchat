# 1) Public: /health
- id: allow-health
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/public/health
    methods: [GET, HEAD, OPTIONS]
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# 2) Public: /billing/plans
- id: allow-billing-plans
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/public/billing/plans
    methods: [GET, HEAD, OPTIONS]
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# 3) Public: /stripe/webhook
- id: allow-stripe-webhook
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/public/stripe/webhook
    methods: [POST, HEAD, OPTIONS]
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# 4) Everything else: must be authenticated (MUST BE LAST!)
- id: auth
  upstream:
    url: "http://app:8080"
  match:
    url: <http|https>://<[^/]+>/<(?!public/)><.*>
    methods: [GET, POST, PUT, PATCH, DELETE, HEAD, OPTIONS]
  authenticators:
    - handler: cookie_session
  authorizer:
    handler: allow
  mutators:
    - handler: header
